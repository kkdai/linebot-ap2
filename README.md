# AP2 LINE Bot - æ™ºèƒ½è³¼ç‰©èˆ‡æ”¯ä»˜åŠ©æ‰‹

## å°ˆæ¡ˆç°¡ä»‹

é€™æ˜¯ä¸€å€‹æ•´åˆ Google ADK (Agent SDK) å’Œ Gemini AI æ¨¡å‹çš„æ™ºèƒ½ LINE Botï¼Œå°ˆç‚ºé›»å•†è³¼ç‰©å’Œ AP2 æ”¯ä»˜å”è­°è¨­è¨ˆã€‚æ©Ÿå™¨äººå…·å‚™å®Œæ•´çš„è³¼ç‰©é«”é©—åŠŸèƒ½ï¼Œå¾å•†å“æœå°‹åˆ°å®‰å…¨æ”¯ä»˜ä¸€æ‡‰ä¿±å…¨ã€‚

## æˆªåœ–å±•ç¤º

![image](https://github.com/user-attachments/assets/2bcbd827-0047-4a3a-8645-f8075d996c10)

## æ ¸å¿ƒåŠŸèƒ½

### ğŸ›ï¸ æ™ºèƒ½è³¼ç‰©åŠ©æ‰‹
- **å•†å“æœå°‹èˆ‡æ¨è–¦**: æ ¹æ“šé—œéµå­—æˆ–é¡åˆ¥æœå°‹å•†å“ï¼Œæä¾›å€‹äººåŒ–æ¨è–¦
- **å•†å“è©³æƒ…æŸ¥è©¢**: æŸ¥çœ‹å•†å“åƒ¹æ ¼ã€åº«å­˜ã€æè¿°ç­‰è©³ç´°è³‡è¨Š
- **è³¼ç‰©è»Šç®¡ç†**: å‰µå»ºè³¼ç‰©è»Šæ¸…å–®å’Œè¨‚å–®

### ğŸ’³ AP2 å®‰å…¨æ”¯ä»˜ç³»çµ±
- **å¤šç¨®æ”¯ä»˜æ–¹å¼**: æ”¯æ´ä¿¡ç”¨å¡ç­‰å¤šç¨®ä»˜æ¬¾æ–¹å¼ç®¡ç†
- **OTP é›™é‡é©—è­‰**: æä¾› OTP é©—è­‰ç¢¼ç¢ºä¿äº¤æ˜“å®‰å…¨
- **äº¤æ˜“è¿½è¹¤**: æŸ¥è©¢äº¤æ˜“ç‹€æ…‹å’Œæ­·å²è¨˜éŒ„
- **é€€æ¬¾è™•ç†**: æ”¯æ´å®‰å…¨çš„é€€æ¬¾æ©Ÿåˆ¶

### ğŸŒ¤ï¸ å¤©æ°£èˆ‡æ™‚é–“æŸ¥è©¢
- **å³æ™‚å¤©æ°£**: æŸ¥è©¢æŒ‡å®šåŸå¸‚çš„å¤©æ°£ç‹€æ³
- **æ™‚é–“è³‡è¨Š**: ç²å–å„åœ°å€çš„ç•¶å‰æ™‚é–“

### ğŸ¤– æ™ºèƒ½æ„åœ–è­˜åˆ¥
- **è‡ªå‹•è·¯ç”±**: æ ¹æ“šç”¨æˆ¶è¨Šæ¯å…§å®¹è‡ªå‹•åˆ¤æ–·æ„åœ–ä¸¦è½‰è‡³å°æ‡‰ä»£ç†
- **å¤šèªè¨€æ”¯æ´**: æ”¯æ´ç¹é«”ä¸­æ–‡å’Œè‹±æ–‡é—œéµå­—è­˜åˆ¥
- **ä¸Šä¸‹æ–‡å°è©±**: ç¶­æŒå°è©±ä¸Šä¸‹æ–‡ï¼Œæä¾›é€£è²«çš„äº’å‹•é«”é©—

## ä½¿ç”¨æŠ€è¡“

- **Python 3.10+**: ä¸»è¦é–‹ç™¼èªè¨€
- **FastAPI**: é«˜æ•ˆèƒ½ç•°æ­¥ Web æ¡†æ¶
- **LINE Messaging API**: LINE å®˜æ–¹è¨Šæ¯ API
- **Google ADK (Agent SDK)**: Google ä»£ç†é–‹ç™¼å¥—ä»¶
- **Google Gemini 2.0 Flash**: æœ€æ–° AI æ¨¡å‹
- **AP2 Protocol**: å®‰å…¨æ”¯ä»˜å”è­°æ•´åˆ
- **Docker**: å®¹å™¨åŒ–éƒ¨ç½²
- **Google Cloud Run**: é›²ç«¯éƒ¨ç½²å¹³å°

## ä¸»è¦ä»£ç†ç³»çµ±

### è³¼ç‰©ä»£ç† (Shopping Agent)
- è™•ç†å•†å“æœå°‹å’Œæ¨è–¦
- ç®¡ç†è³¼ç‰©è»Šå’Œè¨‚å–®å‰µå»º
- æ”¯æ´å¤šç¨®å•†å“é¡åˆ¥ (é›»å­ç”¢å“ã€é›»è…¦ã€éŸ³éŸ¿ã€ç©¿æˆ´è£ç½®)

### æ”¯ä»˜ä»£ç† (Payment Agent)  
- æ•´åˆ AP2 å®‰å…¨æ”¯ä»˜æµç¨‹
- OTP é©—è­‰å’Œäº¤æ˜“ç¢ºèª
- æ”¯ä»˜æ–¹å¼ç®¡ç†å’Œé€€æ¬¾è™•ç†

### å¤©æ°£æ™‚é–“ä»£ç† (Weather Time Agent)
- æä¾›å¤©æ°£è³‡è¨ŠæŸ¥è©¢
- å¤šæ™‚å€æ™‚é–“æŸ¥è©¢åŠŸèƒ½

## ç’°å¢ƒè¨­å®š

### å¿…è¦ç’°å¢ƒè®Šæ•¸
è¨­å®šä»¥ä¸‹ç’°å¢ƒè®Šæ•¸ï¼š
- `ChannelSecret`: LINE é »é“å¯†é‘°
- `ChannelAccessToken`: LINE é »é“å­˜å–æ¬Šæ–
- `GOOGLE_API_KEY`: Google Gemini API é‡‘é‘°
- `GOOGLE_GENAI_USE_VERTEXAI`: æ˜¯å¦ä½¿ç”¨ Vertex AI (é è¨­ç‚º FALSE)

### Vertex AI è¨­å®š (é¸ç”¨)
å¦‚æœè¨­å®š `GOOGLE_GENAI_USE_VERTEXAI=True`ï¼Œéœ€é¡å¤–è¨­å®šï¼š
- `GOOGLE_CLOUD_PROJECT`: Google Cloud å°ˆæ¡ˆ ID
- `GOOGLE_CLOUD_LOCATION`: Google Cloud åœ°å€

### å®‰è£æ­¥é©Ÿ

1. è¤‡è£½å°ˆæ¡ˆåˆ°æœ¬åœ°ç«¯
   ```bash
   git clone <repository-url>
   cd linebot-ap2
   ```

2. å®‰è£ç›¸ä¾å¥—ä»¶
   ```bash
   pip install -r requirements.txt
   ```

3. è¨­å®šç’°å¢ƒè®Šæ•¸ä¸¦å•Ÿå‹•æœå‹™
   ```bash
   uvicorn main:app --host 0.0.0.0 --port 8080
   ```

4. è¨­å®š LINE Bot webhook URL æŒ‡å‘æ‚¨çš„ä¼ºæœå™¨ç«¯é»

## ä½¿ç”¨æ–¹å¼

### ğŸ’¬ å°è©±ç¯„ä¾‹

**è³¼ç‰©ç›¸é—œ:**
- "æˆ‘æƒ³è²· iPhone" â†’ è‡ªå‹•è½‰è‡³è³¼ç‰©ä»£ç†
- "æ¨è–¦ä¸€äº›ç”¢å“çµ¦æˆ‘" â†’ æä¾›å•†å“æ¨è–¦
- "MacBook æœ‰åº«å­˜å—ï¼Ÿ" â†’ æŸ¥è©¢å•†å“è©³æƒ…

**æ”¯ä»˜ç›¸é—œ:**
- "æˆ‘è¦ä»˜æ¬¾" â†’ è½‰è‡³æ”¯ä»˜ä»£ç†
- "ç¢ºèªè³¼è²·" â†’ å•Ÿå‹• AP2 æ”¯ä»˜æµç¨‹
- "é©—è­‰ç¢¼æ˜¯ 123456" â†’ OTP é©—è­‰

**å¤©æ°£æ™‚é–“:**
- "å°åŒ—å¤©æ°£å¦‚ä½•ï¼Ÿ" â†’ æŸ¥è©¢å¤©æ°£è³‡è¨Š
- "ç´ç´„ç¾åœ¨å¹¾é»ï¼Ÿ" â†’ æŸ¥è©¢ç•¶åœ°æ™‚é–“

### ğŸ”„ æ™ºèƒ½è·¯ç”±ç³»çµ±
æ©Ÿå™¨äººæœƒè‡ªå‹•æ ¹æ“šè¨Šæ¯å…§å®¹åˆ¤æ–·ç”¨æˆ¶æ„åœ–ï¼š
- åµæ¸¬è³¼ç‰©é—œéµå­— â†’ è³¼ç‰©ä»£ç†
- åµæ¸¬æ”¯ä»˜é—œéµå­— â†’ æ”¯ä»˜ä»£ç†  
- åµæ¸¬å¤©æ°£æ™‚é–“é—œéµå­— â†’ å¤©æ°£æ™‚é–“ä»£ç†

## éƒ¨ç½²é¸é …

### æœ¬åœ°é–‹ç™¼

ä½¿ç”¨ ngrok ç­‰å·¥å…·å°‡æœ¬åœ°ä¼ºæœå™¨æš´éœ²è‡³ç¶²éš›ç¶²è·¯ä»¥ä¾› webhook å­˜å–ï¼š

```bash
ngrok http 8080
```

### Docker éƒ¨ç½²

ä½¿ç”¨å…§å»ºçš„ Dockerfile å»ºç½®å’Œéƒ¨ç½²æ‡‰ç”¨ç¨‹å¼ï¼š

```bash
docker build -t linebot-ap2 .
docker run -p 8080:8080 \
  -e ChannelSecret=YOUR_SECRET \
  -e ChannelAccessToken=YOUR_TOKEN \
  -e GOOGLE_API_KEY=YOUR_GEMINI_KEY \
  linebot-ap2
```

### Google Cloud éƒ¨ç½²

#### å‰ç½®éœ€æ±‚

1. å®‰è£ [Google Cloud SDK](https://cloud.google.com/sdk/docs/install)
2. å»ºç«‹ Google Cloud å°ˆæ¡ˆä¸¦å•Ÿç”¨ä»¥ä¸‹ APIï¼š
   - Cloud Run API
   - Container Registry API æˆ– Artifact Registry API
   - Cloud Build API

#### éƒ¨ç½²æ­¥é©Ÿ

1. é©—è­‰ Google Cloudï¼š
   ```bash
   gcloud auth login
   ```

2. è¨­å®š Google Cloud å°ˆæ¡ˆï¼š
   ```bash
   gcloud config set project YOUR_PROJECT_ID
   ```

3. å»ºç½®ä¸¦æ¨é€ Docker æ˜ åƒè‡³ Google Container Registryï¼š
   ```bash
   gcloud builds submit --tag gcr.io/YOUR_PROJECT_ID/linebot-ap2
   ```

4. éƒ¨ç½²è‡³ Cloud Runï¼š
   ```bash
   gcloud run deploy linebot-ap2 \
     --image gcr.io/YOUR_PROJECT_ID/linebot-ap2 \
     --platform managed \
     --region asia-east1 \
     --allow-unauthenticated \
     --set-env-vars ChannelSecret=YOUR_SECRET,ChannelAccessToken=YOUR_TOKEN,GOOGLE_API_KEY=YOUR_GEMINI_KEY
   ```

   æ³¨æ„ï¼šç”Ÿç”¢ç’°å¢ƒå»ºè­°ä½¿ç”¨ Secret Manager å„²å­˜æ•æ„Ÿçš„ç’°å¢ƒè®Šæ•¸ã€‚

5. å–å¾—æœå‹™ URLï¼š
   ```bash
   gcloud run services describe linebot-ap2 --platform managed --region asia-east1 --format 'value(status.url)'
   ```

6. åœ¨ LINE Developer Console ä¸­è¨­å®šæœå‹™ URL ä½œç‚º LINE Bot webhook URLã€‚

#### Setting Up Secrets in Google Cloud (Recommended)

For better security, store your API keys as secrets:

1. Create secrets for your sensitive values:

   ```
   echo -n "YOUR_SECRET" | gcloud secrets create line-channel-secret --data-file=-
   echo -n "YOUR_TOKEN" | gcloud secrets create line-channel-token --data-file=-
   echo -n "YOUR_GEMINI_KEY" | gcloud secrets create gemini-api-key --data-file=-
   ```

2. Give the Cloud Run service access to these secrets:

   ```
   gcloud secrets add-iam-policy-binding line-channel-secret --member=serviceAccount:YOUR_PROJECT_NUMBER-compute@developer.gserviceaccount.com --role=roles/secretmanager.secretAccessor
   gcloud secrets add-iam-policy-binding line-channel-token --member=serviceAccount:YOUR_PROJECT_NUMBER-compute@developer.gserviceaccount.com --role=roles/secretmanager.secretAccessor
   gcloud secrets add-iam-policy-binding gemini-api-key --member=serviceAccount:YOUR_PROJECT_NUMBER-compute@developer.gserviceaccount.com --role=roles/secretmanager.secretAccessor
   ```

3. Deploy with secrets:

   ```
   gcloud run deploy linebot-adk \
     --image gcr.io/YOUR_PROJECT_ID/linebot-adk \
     --platform managed \
     --region asia-east1 \
     --allow-unauthenticated \
     --update-secrets=ChannelSecret=line-channel-secret:latest,ChannelAccessToken=line-channel-token:latest,GEMINI_API_KEY=gemini-api-key:latest
   ```

## Maintenance and Monitoring

After deployment, you can monitor your service through the Google Cloud Console:

1. View logs: `gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=linebot-adk"`
2. Check service metrics: Access the Cloud Run dashboard in Google Cloud Console
3. Set up alerts for error rates or high latency in Cloud Monitoring
